import{r as c,u as b,a as h,j as a,q as D,w as k,i as M,e as x,o as E,l as _,k as B,m as F,L as G,b as w,d as p,_ as O,n as H,p as y,s as W,t as P,v as Q,x as Z,y as J,z as R,A as K,B as X,C as Y,D as ee,Q as N,E as te,O as se}from"./index-fe10a68b.js";import{s as S,L as C,E as A}from"./sprite-f03adbee.js";import{u as ae,a as re,b as ne,c as ie,B as ce,A as z,o as oe,d as le}from"./useResizeWindow-c24fab42.js";import{S as de}from"./SearchInput-ba985705.js";import{T as L}from"./Transition-79643a3e.js";import"./objectWithoutPropertiesLoose-68193569.js";const v=e=>{const t=document.querySelector("link[rel='icon']")||document.createElement("link"),s=t;s.type="image/ico",s.rel="icon",s.href=e,document.head.appendChild(t)},ue="/react-web/assets/faviconMessageTab-9ae18f2b.ico",U="/react-web/assets/faviconTab-e4043aa9.ico",he=(e,t)=>{const s=c.useRef(null),{t:r}=b("translation",{keyPrefix:"ChatListUnreadMsg"});c.useEffect(()=>{const n="React Web Messenger";return(()=>{if(t){if(e){const o=()=>{document.title===n?(document.title=e===1?`(${e}) ${r("UnreadMessage")}`:`(${e}) ${r("UnreadMessages")}`,v(ue)):(document.title=n,v(U))};s.current&&(clearInterval(s.current),s.current=null),s.current=setInterval(o,2e3)}}else v(U),s.current&&(clearInterval(s.current),s.current=null),document.title=n})(),()=>{s.current&&(clearInterval(s.current),s.current=null),v(U),document.title=n}},[e,t,r])},fe=()=>{const[e,t]=c.useState(0),s=h(r=>r.totalUnreadMessages);return c.useEffect(()=>{const r=Object.values(s).reduce((n,i)=>n+=i,0);r!==e&&t(r)},[s,e]),e!==0?e:null},me=({docHidden:e})=>{const t=fe();return he(t,e),null},xe=({isShowNotifyMsg:e})=>{const{t}=b("translation",{keyPrefix:"General"});return a.jsx(a.Fragment,{children:e&&a.jsx("div",{className:"relative h-full w-full overflow-hidden bg-transparent xl:flex xl:flex-col xl:items-center",children:a.jsx("h2",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rounded-xl bg-mediumDarkZinc p-4 text-center font-black text-white",children:t("EmptyChatNotify")})})})},pe=({userUID:e})=>{const{t}=b("translation",{keyPrefix:"General"}),s=ae(e);return a.jsx("div",{className:`${s?"text-veryDarkGreen":"text-veryDarkRed"}`,children:t(s?"Online":"Offline")})},ge=(e,t)=>{const s=h(r=>r.updateTotalUnreadMessages);c.useEffect(()=>{t&&s(e?{[t]:e}:{[t]:0})},[t,e,s])},be=({chatUID:e})=>{const t=re(e);return ge(t,e),a.jsx(a.Fragment,{children:t>0&&a.jsx("p",{className:"flex items-center justify-center rounded-full border border-white bg-veryDarkGray p-1 px-3 text-white shadow-mainShadow",children:t})})},ye=e=>{const[t,s]=c.useState(!0),{uid:r}=h(n=>n.currentUser);return c.useEffect(()=>{if(!e||!r)return;const n=D(M(x,`chats/${e}/messages`),k("isRead","==",!1),k("senderUserID","==",r)),i=E(n,o=>{o.docs.length>0?s(!1):s(!0)});return()=>{i()}},[e,r]),t},Ce=({senderUserID:e,itemChatUID:t})=>{const{chatUID:s}=h(i=>i.currentChatInfo),{uid:r}=h(i=>i.currentUser),n=ye(t);return a.jsx(a.Fragment,{children:e===r&&(n?a.jsx("svg",{width:48,height:48,className:`${s===t?"fill-white":"fill-ultraDarkZinc dark:fill-white"}`,children:a.jsx("use",{href:S+"#icon-double-check",className:"shadow-avatarShadow"})}):a.jsx("svg",{width:48,height:48,className:`${s===t?"fill-white":"fill-ultraDarkZinc dark:fill-white"} drop-shadow-2xl`,children:a.jsx("use",{href:S+"#icon-single-check",className:"drop-shadow-2xl"})}))})},je=e=>{const[t,s]=c.useState(null);return c.useEffect(()=>{const r=D(M(x,`chats/${e}/messages`),B("date","desc"),_(1)),n=E(r,i=>{if(i.empty)s(null);else{const o=i.docs[0].data();s(o)}});return()=>{n()}},[e]),t},T=(e,t)=>{const s=e.fileDescription?`${e.fileDescription} ${e.message}`:e.message;return s.length<=t?s:s.substring(0,t)+"..."},ve=({currentChatUID:e,chatInfo:t,userInfo:s})=>{const r=t[0],n=je(r),i=n==null?void 0:n.senderUserID,o=t[1].userUID;return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"w-full",children:[a.jsx("p",{className:`font-bold ${e===r?"text-white":"text-ultraDarkZinc dark:text-white"}`,children:s==null?void 0:s.displayName}),a.jsx("p",{className:`w-full sm:w-100px md:hidden ${e===r?"text-white":"text-darkZinc dark:text-veryLightZinc"}`,children:n&&T(n,10)}),a.jsx("p",{className:`hidden md:block ${e===r?"text-white":"text-darkZinc dark:text-veryLightZinc"}`,children:n&&T(n,25)})]}),r&&a.jsx(be,{chatUID:r}),i&&r&&a.jsx(Ce,{itemChatUID:r,senderUserID:i}),a.jsx(pe,{userUID:o})]})},I=(e,t)=>{t(e)},ke=({chatInfo:e})=>{const t=F(),{chatUID:s}=h(l=>l.currentChatInfo),r=h(l=>l.updateCurrentChatInfo),n=ne(e[1].userUID),i=ie(n==null?void 0:n.photoURL),o=()=>{if(e[0]){const l={chatUID:e[0],userUID:e[1].userUID,tokenFCM:n==null?void 0:n.tokenFCM};I(l,r)}};return a.jsx("li",{className:"block w-full border border-charcoal border-l-transparent border-r-transparent p-2",onClick:o,children:a.jsxs(G,{className:`group flex h-72px content-center items-center gap-3 rounded-md p-1 transition-all duration-300 ${s===e[0]&&"bg-veryDarkZinc hover:bg-darkZinc dark:bg-mediumDarkCyan hover:dark:bg-veryDarkCyan"} ${s!==e[0]&&"hover:bg-mediumZinc hover:dark:bg-veryDarkZinc"} `,to:`/${e[0]}`,state:{from:t},children:[a.jsx(ce,{loading:i,children:a.jsx(z,{photoURL:n==null?void 0:n.photoURL,displayName:n==null?void 0:n.displayName,size:"50"})}),a.jsx(ve,{currentChatUID:s,chatInfo:e,userInfo:n})]})})},we=()=>{const[e,t]=c.useState(!0),[s,r]=c.useState(null);return c.useEffect(()=>{var i,o,l,f;if(!((o=(i=w)==null?void 0:i.currentUser)!=null&&o.uid))return;t(!0);const n=E(p(x,"userChats",(f=(l=w)==null?void 0:l.currentUser)==null?void 0:f.uid),d=>{const u=d.data();let m=!0;for(const g in u)if(Object.prototype.hasOwnProperty.call(u,g)&&!u[g].date){m=!1;break}if(m&&u){const g=Object.entries(u).sort((j,V)=>V[1].date-j[1].date);r(g),t(!1)}});return()=>{n()}},[]),{isLoading:e,myUserChatList:s}},Ue=()=>{const{t:e}=b("translation",{keyPrefix:"Sidebar"}),{isLoading:t,myUserChatList:s}=we();return a.jsxs("div",{children:[t&&a.jsx("div",{className:"flex justify-center",children:a.jsx(C,{size:100})}),!t&&s&&s.length>0?a.jsx("ul",{className:"m-0 h-full p-0",children:s.map(r=>a.jsx(ke,{chatInfo:r},r[0]))}):a.jsx(a.Fragment,{children:!t&&a.jsx("div",{children:a.jsx("p",{className:"text-center font-black text-black dark:text-white",children:e("NoChats")})})})]})},Ne=c.lazy(()=>O(()=>import("./NavbarModal-b91e31c1.js"),["assets/NavbarModal-b91e31c1.js","assets/index-fe10a68b.js","assets/index-af5a0e8a.css","assets/ModalWindow-692bcdc1.js","assets/useCloseModal-02386773.js","assets/useResizeWindow-c24fab42.js","assets/Theme-299fe45d.js","assets/sprite-f03adbee.js","assets/useStartTransition-55d240ad.js","assets/Transition-79643a3e.js","assets/objectWithoutPropertiesLoose-68193569.js"])),Se=()=>{const[e,t]=c.useState(!1),s=()=>{t(r=>!r)};return a.jsxs("div",{children:[a.jsx("button",{className:"relative flex h-10 w-12 cursor-pointer items-center justify-center rounded-full bg-transparent transition-all duration-300 hover:bg-mediumZinc hover:dark:bg-veryLightZincOpacity10",type:"button",onClick:s,"aria-label":"Navbar",children:a.jsx("svg",{width:32,height:32,className:"fill-ultraDarkZinc dark:fill-mediumZinc",children:a.jsx("use",{href:S+"#icon-menu"})})}),a.jsx(c.Suspense,{fallback:a.jsx("div",{className:"absolute left-4 top-2",children:a.jsx(C,{size:40})}),children:e&&a.jsx(Ne,{handleToggleModal:s})})]})},Le=e=>e.charAt(0).toUpperCase()+e.slice(1),De=e=>e.split(" ").map(r=>Le(r)).join(" "),Me=()=>{const[e,t]=c.useState(!1),[s,r]=c.useState(null),n=h(l=>l.searchValue),[i]=oe(n,300);c.useEffect(()=>{if(i.trim()===""){r(null);return}return(async()=>{t(!0);const f=De(i).trim(),d=M(x,"users"),u=D(d,k("displayName",">=",f),k("displayName","<=",f+"ï£¿"));try{const m=await H(u);r(m)}catch(m){console.error("Error fetching data:",m)}finally{t(!1)}})(),()=>{r(null)}},[i]);const o=c.useCallback(()=>{r(null)},[]);return{isLoading:e,searchChatList:s,handleResetSearchChatList:o}},Ee=async e=>{await W(p(x,"chats",e),{})},$=async(e,t,s)=>{await P(p(x,"userChats",e),{[`${t}.userUID`]:s,[`${t}.date`]:Q()})},Ie=async e=>(await y(p(x,"chats",e))).exists(),Re=async(e,t)=>{var r;return(r=(await y(p(x,"userChats",e))).data())==null?void 0:r[t]},Te=async(e,t,s)=>{var o,l,f;if(!((l=(o=w)==null?void 0:o.currentUser)!=null&&l.uid))return;const r=w.currentUser.uid,n=e.uid,i=r>n?r+n:n+r;try{await Ie(i)||(await Ee(i),await $(r,i,n),await $(n,i,r));const u=await Re(r,i),m=await y(p(x,"users",u.userUID));if(u&&m){const g={chatUID:i,userUID:u.userUID,tokenFCM:(f=m.data())==null?void 0:f.tokenFCM};I(g,t),s(i)}}catch(d){console.log("handleCreateAndNavigateToChat error",d)}},$e=()=>{const e=Z(),{t}=b("translation",{keyPrefix:"Sidebar"}),s=h(d=>d.currentUser),r=h(d=>d.updateSearchValue),n=h(d=>d.updateCurrentChatInfo),{isLoading:i,searchChatList:o,handleResetSearchChatList:l}=Me(),f=d=>{Te(d,n,e),l(),r("")};return a.jsxs("div",{className:"px-2",children:[i&&a.jsx(C,{size:50}),!i&&o&&o.size>0?a.jsx("ul",{children:o.docs.map(d=>{if(d.data().uid===s.uid)return null;const u=d.data();return a.jsxs("li",{className:"group flex h-72px content-center items-center gap-3 rounded-md p-2 transition-all duration-300 hover:cursor-pointer hover:bg-mediumZinc",onClick:()=>f(u),children:[a.jsx(z,{photoURL:u.photoURL,displayName:u.displayName,size:"50"}),a.jsx("p",{className:"font-semibold text-darkZinc dark:text-mediumZinc",children:u.displayName})]},d.id)})}):a.jsx(a.Fragment,{children:!i&&o&&a.jsx("div",{children:a.jsx("p",{className:"font-black text-black dark:text-white",children:t("UsersNotFound")})})})]})},Fe=()=>{const{t:e}=b("translation",{keyPrefix:"General"}),t=h(n=>n.searchValue),s=h(n=>n.updateSearchValue),r=n=>{s(n.target.value)};return a.jsx(de,{value:t,handleChange:r,placeholderText:e("Search"),autoFocus:!1})},Oe=c.lazy(()=>O(()=>import("./ProfileSettings-5ed0f6e4.js"),["assets/ProfileSettings-5ed0f6e4.js","assets/index-fe10a68b.js","assets/index-af5a0e8a.css","assets/useResizeWindow-c24fab42.js","assets/ButtonArrow-ad4b1aab.js","assets/sprite-f03adbee.js","assets/FileInput-d93ee551.js","assets/useStartTransition-55d240ad.js","assets/Transition-79643a3e.js","assets/objectWithoutPropertiesLoose-68193569.js"])),q=c.memo(()=>{const e=c.useRef(null),t=h(s=>s.sidebarScreen);return a.jsxs("div",{className:"relative h-full w-full border-r border-r-ultraDarkZinc bg-main dark:bg-mainBlack sm:w-300px md:w-400px",children:[a.jsx(L,{nodeRef:e,in:t==="default",timeout:300,unmountOnExit:!0,children:s=>a.jsxs("div",{ref:e,className:`h-full w-full origin-top-left transform transition-transform ${s==="exited"?"hidden":""} ${s==="entered"?"translate-x-0 rotate-0":"-translate-x-1/2 rotate-180 duration-300"} `,children:[a.jsxs("div",{className:"flex gap-2 px-3 py-2",children:[a.jsx(Se,{}),a.jsx(Fe,{})]}),a.jsxs("div",{style:{position:"relative",overflow:"scroll",width:"100%",height:"calc(100% - 48px)"},children:[a.jsx($e,{}),a.jsx(Ue,{})]})]})}),t==="profileSettings"&&a.jsx(c.Suspense,{fallback:a.jsx("div",{className:"absolute left-1/2 -translate-x-1/2",children:a.jsx(C,{size:200})}),children:a.jsx(Oe,{})})]})});q.displayName="Sidebar";const Pe=()=>{const[e,t]=c.useState(!1);return c.useEffect(()=>{const s=()=>{document.hidden?t(!0):t(!1)};return document.addEventListener("visibilitychange",s),()=>{document.removeEventListener("visibilitychange",s)}},[]),e},Ze=()=>{const e=h(t=>t.currentUser.uid);c.useEffect(()=>{if(e){const t=J(X,"status/"+e);R(t,!0);const s=K(t);return s.set(!1),()=>{s.cancel(),R(t,!1)}}},[e])},Ae=()=>{const e=Z(),t=h(r=>r.currentUser.uid),s=h(r=>r.updateCurrentChatInfo);c.useEffect(()=>{(async(n,i,o)=>{var f,d,u;const l=localStorage.getItem("currentChatId");if(l&&n){const m=await y(p(x,"userChats",n)),g=await y(p(x,"users",(f=m.data())==null?void 0:f[l].userUID)),j={chatUID:l,userUID:(d=m.data())==null?void 0:d[l].userUID,tokenFCM:(u=g.data())==null?void 0:u.tokenFCM};i(j,o),e(l)}})(t,I,s)},[t,e,s])},ze=()=>{const e=document.getElementById(A.NotifyAudio);e&&e.play()},qe=()=>{const e=h(t=>t.currentUser.uid);c.useEffect(()=>{if(!e)return;(async()=>{try{const s=await ee();if(!s){N.warn("Notification permission was not granted, you do not have token for firebase cloud messaging");return}await P(p(x,"users",e),{tokenFCM:s})}catch(s){console.error("Error updating token:",s)}})()},[e]),c.useEffect(()=>{const t=async r=>{try{const{notification:n}=r;ze(),N.info(`${n.title}: ${n.body}`)}catch(n){console.error("Error handling new message:",n)}},s=Y(te,r=>{t(r)});return()=>{s()}},[])},Ve=()=>{c.useEffect(()=>{(async()=>{try{if(!("Notification"in window)){N.warn("This browser does not support notifications.");return}if(Notification.permission==="granted")return;const t=async()=>{try{await Notification.requestPermission()}catch(s){console.error("Failed to request notification permission:",s)}};return document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}}catch(t){console.error("Failed to request notification permission:",t)}})()},[])},_e="/react-web/assets/notify-d07c9a9b.mp3",Ke=()=>{const e=c.useRef(null),t=c.useRef(null),{pathname:s}=F(),{isFullScreen:r,heightWindow:n}=le(),i=Pe();return Ve(),Ze(),Ae(),qe(),a.jsxs("main",{className:"flex w-full overflow-hidden bg-main-bcg2 bg-cover bg-center bg-no-repeat",style:{height:`${n}px`,overflow:"hidden"},children:[a.jsx(L,{nodeRef:e,in:(s==="/"?"Sidebar":"Chat")=="Sidebar"||r,timeout:300,unmountOnExit:!0,children:o=>a.jsx("div",{ref:e,className:`w-full sm:w-300px md:w-400px ${o==="exited"?"hidden":""} transform transition-transform ${o==="entered"?"translate-x-0 scale-100":"-translate-x-full scale-0"}`,children:a.jsx(q,{})})}),a.jsx(L,{nodeRef:t,in:(s==="/"?"Sidebar":"Chat")=="Chat"||r,timeout:300,unmountOnExit:!0,children:o=>a.jsxs("div",{ref:t,className:`relative w-full transform transition-transform ${o==="exited"?"hidden":""} ${o==="entered"?"translate-x-0 scale-100":"translate-x-full scale-0"}`,children:[a.jsx(xe,{isShowNotifyMsg:s==="/"&&r}),a.jsx(c.Suspense,{fallback:a.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",children:a.jsx(C,{size:200})}),children:a.jsx(se,{})})]})}),i&&a.jsx(me,{docHidden:i}),a.jsx("audio",{id:A.NotifyAudio,src:_e,children:a.jsx("track",{kind:"captions",src:"",srcLang:"en",label:"English captions"})})]})};export{Ke as default};
