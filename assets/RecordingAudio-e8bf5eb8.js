import{r as u,j as a,F as D,T as C,i as S,e as U,I as L,J as T,U as k,K as N,a as x}from"./index-1dbf5670.js";import{s as y}from"./sprite-f89b8981.js";import{M as F,m as M,r as Z}from"./ChatPage-df9b8a98.js";import{v as $}from"./v4-4a60fe23.js";import"./useCloseModal-32ba7e76.js";import"./FileInput-5d4d35cc.js";import"./useResizeWindow-7f7b4e96.js";import"./convertTimeWithZero-0e4ead24.js";const B=u.forwardRef(({isRecording:t,recordingDuration:e},n)=>a.jsxs("div",{className:`absolute right-28 top-1/2 z-20 flex -translate-y-1/2 items-center gap-2 rounded-full bg-lightRed px-3 py-1 ${t?"block":"hidden"}`,children:[a.jsx("svg",{width:24,height:24,className:"animate-pulse fill-veryDarkRed",children:a.jsx("use",{href:y+"#icon-rec"})}),a.jsx("canvas",{className:"h-5 w-40 sm:w-8 md:w-40 lg:w-52",ref:n,width:192,height:20}),t&&e&&a.jsx("span",{className:"w-8",children:e.toFixed(1)})]})),E=({cancelRecording:t})=>a.jsx("button",{className:"flex h-12 w-12 cursor-pointer items-center justify-center rounded-full bg-transparent transition-all duration-300 hover:bg-veryLightZincOpacity20 hover:dark:bg-veryLightZincOpacity10",type:"button",onClick:t,"aria-label":"Cancel recording",children:a.jsx("svg",{width:24,height:24,className:"fill-mediumLightZinc dark:fill-mediumZinc",children:a.jsx("use",{href:y+"#icon-delete-button"})})}),I=({stopRecordingAndSendAudio:t})=>a.jsx("button",{className:"flex h-12 w-12 cursor-pointer items-center justify-center rounded-full bg-transparent transition-all duration-300 hover:bg-veryLightZincOpacity20 hover:dark:bg-veryLightZincOpacity10",type:"button",onClick:t,"aria-label":"Stop recording and send audio",children:a.jsx("svg",{width:24,height:24,className:"fill-mediumLightZinc dark:fill-mediumZinc",children:a.jsx("use",{href:y+"#icon-stop"})})}),w=(t,e,n)=>{var o;const r=(o=t==null?void 0:t.current)==null?void 0:o.stream.getTracks();r==null||r.forEach(c=>c.stop()),n([]),t.current=null,e.current&&(e.current.disconnect(),e.current=null)},O=(t,e,n,r,o,c)=>{u.useEffect(()=>{const s=e.current,i=n.current;return()=>{s&&(cancelAnimationFrame(s),e.current=null),i&&(i.stop(),i.onstop=()=>{w(n,r,o),c()})}},[t,c,r,o,e,n])},z=(t,e,n)=>{t.clearRect(0,0,e,n)},R=(t,e,n,r)=>{t.beginPath();const o=n*1/e.length;let c=0;for(let s=0;s<e.length;s++){const l=e[s]/128*r/2;s===0?t.moveTo(c,l):t.lineTo(c,l),c+=o}t.lineTo(n,r/2),t.stroke()},v=(t,e,n,r)=>{const o=t.getContext("2d");if(!o){console.error("Unable to get 2D context for canvas");return}const c=t.width,s=t.height;e.getByteTimeDomainData(n),z(o,c,s),R(o,n,c,s),r.current=requestAnimationFrame(()=>v(t,e,n,r))},P=()=>new window.AudioContext,V=t=>{const e=t.createAnalyser();return e.fftSize=256,e},q=(t,e,n)=>{e.createMediaStreamSource(t).connect(n)},W=(t,e,n)=>{const r=e.frequencyBinCount,o=new Uint8Array(r);v(t,e,o,n)},J=(t,e,n,r)=>{const o=P(),c=V(o);q(t,o,c),n.current=c;const s=e.current;s&&W(s,c,r)},K=(t,e)=>{const n=Date.now();t.current=setInterval(()=>{e((Date.now()-n)/1e3)},100)},G=(t,e,n,r,o,c,s)=>{const i=u.useRef(null),l="audio/webm";u.useEffect(()=>(t&&(async()=>{const m=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});if(m){K(i,c);const h=new MediaRecorder(m,{mimeType:l});e.current=h,e.current.start();const p=[];e.current.ondataavailable=f=>{typeof f.data>"u"||f.data.size!==0&&p.push(f.data)},s(p),J(m,n,r,o)}})(),()=>{i.current&&(clearInterval(i.current),i.current=null)}),[r,o,n,t,e,s,c])},H=async(t,e,n)=>{const r=`${String.fromCodePoint(127908)} Voice message`;await D(S(U,`chats/${t}/messages`),{type:F.VoiceMessage,file:e,fileDescription:r,message:"",senderUserID:n,date:C.now(),isRead:!1,isEdited:!1,isShowNotification:!0})},Q=async(t,e)=>{const n="mpeg",r={contentType:`audio/${n}`},o=L(T,`${r.contentType}/${e}/${$()}.${n}`);return await k(o,t,r),await N(o)},X=async(t,e,n,r)=>{try{M();const c=[{type:"audio/mpeg",name:"voice audio",url:await Q(t,n)}];await H(e,c,r),Z()}catch(o){console.error("Error sending audio message:",o)}},ct=({isRecording:t,handleToggleRecordingStatus:e})=>{const[n,r]=u.useState([]),[o,c]=u.useState(0),s=u.useRef(null),i=u.useRef(null),l=u.useRef(null),d=u.useRef(null),m=x(g=>g.currentUser.uid),{chatUID:h,userUID:p}=x(g=>g.currentChatInfo),f="audio/webm";G(t,s,i,l,d,c,r),O(n,d,s,l,r,e);const b=()=>{d.current&&(cancelAnimationFrame(d.current),d.current=null),s.current&&(s.current.stop(),s.current.onstop=()=>{w(s,l,r),e()})},j=()=>{d.current&&(cancelAnimationFrame(d.current),d.current=null),s.current&&(s.current.stop(),s.current.onstop=async()=>{const g=new Blob(n,{type:f});if(h&&p&&m)try{w(s,l,r),e(),await X(g,h,p,m)}catch(A){console.log("stopRecordingAndSendAudio error",A)}})};return a.jsxs(a.Fragment,{children:[a.jsx(B,{isRecording:t,recordingDuration:o,ref:i}),a.jsx(E,{cancelRecording:b}),a.jsx(I,{stopRecordingAndSendAudio:j})]})};export{ct as default};
